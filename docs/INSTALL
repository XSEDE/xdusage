xdusage-%VER%-%REL% Install Instructions
========================================

This document describes two ways to install xdusage; the preferred way is to use the new RPM, but the legacy method is described for systems that may still require it.

1) Configure trust in the XSEDE-Production repository

   a) Browse this directory and copy the link to your operating system's package:
      http://software.xsede.org/production/repo/repos/

   b) Install the package at the copied link:
      rpm -i http://software.xsede.org/production/repo/repos/XSEDE-Production-config.<OPERATING SYSTEM>.noarch.rpm
   You should see a warning similar to this:
      warning: XSEDE-Production-config.centos-5-1.noarch.rpm: Header V3 DSA signature: NOKEY, key ID 20423dbb
   This is a trust bootstrapping issue because until you complete this entire procedure, RPM doesn't trust the signer of this RPM.

   c) Lastly, configure RPM to trust XSEDE's signature (PGP key) installed by the above RPM:
      rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-XSEDE-Production

   SECURITY NOTE:
   If you need greater security assurance modify the above procedure as follows:
   a') Browse the package directory using https and review the server's HTTPS/TLS host certificate
   b') Download the package over https using your favorite secure download tool
   c') Verify the RPM before you install it using "rpm -Kv <package>"

NOTE: If you need an SD&I Development version, you will need to configure your system to use the XSEDE-Development
repository by following this procedure https://software.xsede.org/development/repo/repoconfig.txt

2) Install xdusage.

   NOTE: The xdusage rpm will automatically create an "xdusage" account that will own the xdusage install
         and that will execute xdusage via sudo.

   To install to the default location of /usr/local/xdusage-%VER%-%REL%, you can simply do:
   # yum install xdusage

   If you want to install it in a different location, say /soft/xdusage-%VER%-%REL%, you can use the following procedure:
   # yum install yum-downloadonly
   # yum update xdusage -y --downloadonly --downloaddir=./
   # rpm -i --prefix=<INSTALL_DIR> ./xdusage-%VER%%REL%-1.noarch.rpm


3) create the xdusage.admins file, listing, one per line, each user of the local
   system who is an xdusage admin (admins are allowed to perform queries as
   other users).  The xdusage.admins file should be placed in the install dir.

4) edit /etc/sudoers to grant permission for everyone to run xdusage as the non_root user "xdusage" (created when the rpm was installed).  This can be done by adding the two lines from <INSTALL_DIR>/xdusage.sudoers

On SLES11, you may need to use these lines instead, where <not_root_user> should probably be a new user created just for this one program:

# XDUSAGE %VER% %REL%
Defaults>xdusage env_keep="USER XDUSAGE_INSTALL_DIR"
ALL ALL=(xdusage) NOPASSWD: <INSTALL_DIR>/xdusage.pl


5) For each resource at your site that you are deploying xd_usage on, create a file called <INSTALL_DIR>/resource_name that contains the corresponding XDCDB resource_name for that resource.

6) edit <INSTALL_DIR>/xdusage.pl
    On the line:
	 my $PASSWORD="xdusage";
    replace xdusage with the actual password as obtained from the 
    XSEDE SP Coordinator or XSEDE Operations Center.

7) To facilitate incorporation of the target installation directory into users' PATHs, install a modules file for xdusage.  There is a sample file in <install dir>/xdusage.modules that can be copied to /usr/local/Modules/modulefiles/xdusage/%VER%-%REL% (or the appropriate location for your Modules installation) and marked as the default by specifying %VER%-%REL% in the associated /usr/local/Modules/modulefiles/xdusage/.version file.

8) Look at the docs/Testing document for a sanity-check command line to run.

9) Update your login.teragrid.org kit registration with the new version "%VER%" of xdusage
   http://software.teragrid.org/pacman/ctss4/ctss-login-registration/README.config.html

Installing from a tarball (Legacy install method):

Prerequisites: sudo, and the perl modules DBI, DBD:: Pg (compiled with SSL 
support), Getopt::Long, and Date::Manip.

Note:  If you are building DBD::Pg with SSL support yourself, you must:
          export POSTGRES_LIB="/usr/local/pgsql/lib -lssl -lcrypto"
       before building.  See the INSTALLATION section of 
          http://cpansearch.perl.org/src/TURNSTEP/DBD-Pg-2.19.3/README
       for more details.

xdusage can be installed in several simple steps:

Note:  installation should be done by a non-privileged user.
	(some sites have a convention of a "software" user that owns the 
	 installed software).  The only step that requires privilege is 
	editing /etc/sudoers.

1) Get the latest xdusage package at:
        http://software.teragrid.org/software/xdusage/latest/

2) Untar the package:
	tar -xzvf xdusage-%VER%-%REL%.tgz

3) cd xdusage-%VER%-%REL%/bin

4) run install.pl, giving as parameters the user that xdusage should run as, and the installation   directory:
	./install.pl -user <not_a_root_user> -dir <INSTALL_DIR>
   Note:  xdusage should be run as a non-root user that does not map to an 
	actual person.  This can be the "software" user.

5) create the xdusage.admins file, listing, one per line, each user of the local
   system who is an xdusage admin (admins are allowed to perform queries as
   other users).  The xdusage.admins file should be placed in the install dir.

6) edit /etc/sudoers to grant permission for everyone to run xdusage as the non_root user specified in 4) above.  This can be done by adding these two lines:

Defaults!<INSTALL_DIR>/xdusage.pl env_keep="USER XDUSAGE_INSTALL_DIR"
ALL ALL=(<not_a_root_user>) NOPASSWD: <INSTALL_DIR>/xdusage.pl

On SLES11, you may need to use these lines instead, where <not_root_user> should probably be a new user created just for this one program:

# XDUSAGE %VER% %REL%
Defaults><not_root_user> env_keep="USER XDUSAGE_INSTALL_DIR"
ALL ALL=(<not_root_user>) NOPASSWD: <INSTALL_DIR>/xdusage.pl

7) For each resource at your site that you are deploying xd_usage on, create a file called <INSTALL_DIR>/resource_name that contains the corresponding XDCDB resource_name for that resource.

8) edit <INSTALL_DIR>/xdusage.pl
    On the line:
	 my $PASSWORD="xdusage";
    replace xdusage with the actual password as obtained from the 
    XSEDE SP Coordinator or XSEDE Operations Center.

9) To facilitate incorporation of the target installation directory into users' PATHs, install a modules file for xdusage.  There is a sample file in <install dir>/xdusage.modules that can be copied to /usr/local/Modules/modulefiles/xdusage/%VER%-%REL% (or the appropriate location for your Modules installation) and marked as the default by specifying %VER%-%REL% in the associated /usr/local/Modules/modulefiles/xdusage/.version file.

10) Look at the docs/Testing document for a sanity-check command line to run.
